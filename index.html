<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëâ≤ÂΩ©ËÆ∞ÂøÜÊåëÊàò ¬∑ Colour Memory Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== Reset & Custom Properties ===== */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-deep: #111113;
            --bg-card: rgba(22, 22, 25, 0.95);
            --border: rgba(255,255,255,0.06);
            --border-hi: rgba(255,255,255,0.10);
            --text-1: rgba(255,255,255,0.88);
            --text-2: rgba(255,255,255,0.45);
            --text-3: rgba(255,255,255,0.25);
            --neutral: #555;
            --neutral-hi: #666;
            --clr-success: #8fbc8f;
            --clr-warning: #bdb58c;
            --clr-danger: #bc8f8f;
            --radius: 14px;
            --ease: cubic-bezier(.4,0,.2,1);
        }

        /* ===== Body & Background ===== */
        body {
            background: var(--bg-deep);
            color: var(--text-1);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            overflow-x: hidden;
        }


        /* ===== Card ===== */
        .app { width: 100%; max-width: 640px; }
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top-color: var(--border-hi);
            border-radius: 20px;
            padding: 28px 24px;
        }

        /* ===== Header ===== */
        .header { text-align: center; margin-bottom: 22px; }
        .header h1 {
            font-size: 22px; font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-1);
        }
        .header .subtitle {
            font-size: 13px; color: var(--text-2); margin-top: 4px;
        }

        /* ===== Game Area ===== */
        .game-area {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            min-height: 240px;
            padding: 16px 0;
        }

        /* -- Memorize Phase -- */
        .phase-memorize {
            display: flex; flex-direction: column; align-items: center;
            animation: fadeSlideIn .35s var(--ease);
        }
        .memorize-swatch {
            width: 150px; height: 150px;
            border-radius: 16px;
            cursor: pointer;
            transition: transform .15s var(--ease);
        }
        .memorize-swatch:hover {
            transform: scale(1.04);
        }
        .phase-hint {
            margin-top: 12px; font-size: 12px;
            color: var(--text-3);
            animation: pulse 2.5s ease-in-out infinite;
        }

        /* -- Transition -- */
        .transition-msg {
            font-size: 14px; color: var(--text-2);
            animation: fadeSlideIn .3s var(--ease);
        }

        /* -- Color Grid -- */
        .color-grid {
            display: grid; gap: 2px;
            animation: fadeSlideIn .3s var(--ease);
        }
        .grid-3  { grid-template-columns: repeat(3, 1fr);  width: min(100%, 318px); }
        .grid-5  { grid-template-columns: repeat(5, 1fr);  width: min(100%, 420px); }
        .grid-10 { grid-template-columns: repeat(10, 1fr); width: min(100%, 510px); }

        .grid-cell {
            aspect-ratio: 1;
            border-radius: 5px;
            cursor: pointer;
            animation: cellReveal .22s var(--ease) both;
            transition: transform .12s var(--ease), box-shadow .12s var(--ease);
        }
        .grid-cell:hover {
            transform: scale(1.08);
            z-index: 2;
        }
        @keyframes cellReveal {
            from { opacity: 0; transform: scale(0.8); }
            to   { opacity: 1; transform: scale(1); }
        }

        /* -- Result -- */
        .result-panel {
            text-align: center;
            animation: fadeSlideIn .35s var(--ease);
        }
        .result-swatches {
            display: flex; align-items: center; justify-content: center;
            gap: 12px; margin-bottom: 20px;
        }
        .result-item {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
        }
        .result-label {
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: .06em; color: var(--text-2);
        }
        .result-swatch {
            width: 90px; height: 90px;
            border-radius: 12px;
        }
        .result-vals {
            font-size: 10px; color: var(--text-3);
            font-family: 'SF Mono', ui-monospace, monospace;
        }
        .result-vs {
            font-size: 12px; font-weight: 700; color: var(--text-3);
            padding: 0 4px;
        }
        .result-score {
            font-size: 52px; font-weight: 700;
            line-height: 1; margin-bottom: 2px;
        }
        .result-score-label {
            font-size: 12px; color: var(--text-2); margin-bottom: 12px;
        }
        .result-bar-wrap { width: 200px; margin: 0 auto 14px; }
        .result-bar {
            width: 100%; height: 5px;
            background: rgba(255,255,255,0.06);
            border-radius: 3px; overflow: hidden;
        }
        .result-bar-fill {
            height: 100%; border-radius: 3px;
            background: linear-gradient(90deg, var(--clr-danger), var(--clr-warning), var(--clr-success));
            transition: width .6s var(--ease);
        }
        .result-delta {
            font-size: 13px; color: var(--text-2); margin-bottom: 6px;
        }
        .result-delta sub { font-size: 10px; }
        .result-feedback { font-size: 15px; margin-top: 2px; }

        /* ===== Controls ===== */
        .controls {
            display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 16px;
        }
        .control-row {
            display: flex; align-items: center; justify-content: space-between;
        }
        .control-label {
            font-size: 13px; font-weight: 500; color: var(--text-2);
        }
        .toggle-group {
            display: flex; gap: 2px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 10px; padding: 3px;
        }
        .toggle-btn {
            padding: 5px 14px; font-size: 13px; font-weight: 500;
            color: var(--text-2);
            background: transparent; border: none;
            border-radius: 7px; cursor: pointer;
            transition: all .18s var(--ease);
            font-family: inherit;
        }
        .toggle-btn:hover { color: var(--text-1); }
        .toggle-btn.active {
            background: var(--neutral); color: #fff;
        }

        /* ===== Primary Button ===== */
        .btn-primary {
            width: 100%; padding: 11px; font-size: 14px; font-weight: 600;
            color: #fff; background: var(--neutral);
            border: none; border-radius: 10px; cursor: pointer;
            font-family: inherit;
            transition: all .18s var(--ease);
        }
        .btn-primary:hover {
            background: var(--neutral-hi);
        }
        .btn-primary:active { opacity: 0.85; }

        /* ===== Stats ===== */
        .stats {
            display: flex; justify-content: center; gap: 32px;
            margin-top: 16px; padding-top: 14px;
            border-top: 1px solid var(--border);
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 18px; font-weight: 700; }
        .stat-label { font-size: 10px; color: var(--text-3); margin-top: 1px; letter-spacing: .04em; }

        /* ===== Animations ===== */
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%,100% { opacity: .45; }
            50%     { opacity: .85; }
        }

        /* ===== Responsive ===== */
        @media (max-width: 480px) {
            .card { padding: 20px 16px; }
            .memorize-swatch { width: 120px; height: 120px; }
            .result-swatch { width: 72px; height: 72px; }
            .result-score { font-size: 40px; }
            .toggle-btn { padding: 5px 10px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="card">
            <header class="header">
                <h1>üé® Ëâ≤ÂΩ©ËÆ∞ÂøÜÊåëÊàò</h1>
                <p class="subtitle">‰Ω†ÁúüÁöÑËÉΩËÆ∞‰Ωè‰∏ÄÁßçÈ¢úËâ≤ÂêóÔºü</p>
            </header>

            <div id="game-area" class="game-area"></div>

            <div class="controls">
                <div class="control-row">
                    <span class="control-label">ÈöæÂ∫¶</span>
                    <div class="toggle-group" id="difficulty-group">
                        <button class="toggle-btn" data-value="9">ÁÆÄÂçï 3√ó3</button>
                        <button class="toggle-btn active" data-value="25">‰∏≠Á≠â 5√ó5</button>
                        <button class="toggle-btn" data-value="100">Âõ∞Èöæ 10√ó10</button>
                    </div>
                </div>
                <div class="control-row">
                    <span class="control-label">Ê®°Âºè</span>
                    <div class="toggle-group" id="mode-group">
                        <button class="toggle-btn active" data-value="grayscale">ÁÅ∞Â∫¶</button>
                        <button class="toggle-btn" data-value="color">ÂΩ©Ëâ≤</button>
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="restart-btn">ÈáçÊñ∞ÂºÄÂßã</button>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="stat-round">0</div>
                    <div class="stat-label">ËΩÆÊ¨°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-best">‚Äî</div>
                    <div class="stat-label">ÊúÄ‰Ω≥ÂæóÂàÜ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-avg">‚Äî</div>
                    <div class="stat-label">Âπ≥ÂùáÂæóÂàÜ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    'use strict';

    /* ============================================================
       OKLab Color Math
       Using Bj√∂rn Ottosson's OKLab for perceptual uniformity.
       CSS oklab() renders colors; hex provides fallback.
       JS-side gamut check ensures all colors are within sRGB.
    ============================================================ */

    const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));

    function oklabToLinearSrgb(L, a, b) {
        const l_ = L + 0.3963377774 * a + 0.2158037573 * b;
        const m_ = L - 0.1055613458 * a - 0.0638541728 * b;
        const s_ = L - 0.0894841775 * a - 1.2914855480 * b;
        return {
            r:  4.0767416621 * (l_**3) - 3.3077115913 * (m_**3) + 0.2309699292 * (s_**3),
            g: -1.2684380046 * (l_**3) + 2.6097574011 * (m_**3) - 0.3413193965 * (s_**3),
            b: -0.0041960863 * (l_**3) - 0.7034186147 * (m_**3) + 1.7076147010 * (s_**3),
        };
    }

    function linearToSrgb(c) {
        return c <= 0.0031308 ? 12.92 * c : 1.055 * c ** (1/2.4) - 0.055;
    }

    function isInGamut(c) {
        const lin = oklabToLinearSrgb(c.L, c.a, c.b);
        const e = 0.001;
        return lin.r >= -e && lin.r <= 1+e && lin.g >= -e && lin.g <= 1+e && lin.b >= -e && lin.b <= 1+e;
    }

    function oklabToHex(c) {
        const lin = oklabToLinearSrgb(c.L, c.a, c.b);
        const to8 = v => Math.round(linearToSrgb(clamp(v, 0, 1)) * 255);
        return '#' + [lin.r, lin.g, lin.b].map(to8).map(v => v.toString(16).padStart(2,'0')).join('');
    }

    /** Returns CSS with hex fallback + oklab() progressive enhancement */
    function colorCss(c) {
        const hex = oklabToHex(c);
        const ok  = `oklab(${c.L.toFixed(4)} ${c.a.toFixed(4)} ${c.b.toFixed(4)})`;
        return `background-color:${hex};background-color:${ok}`;
    }

    function deltaE(c1, c2) {
        return Math.hypot(c1.L - c2.L, c1.a - c2.a, c1.b - c2.b);
    }

    /* ============================================================
       Game State
    ============================================================ */

    const $ = id => document.getElementById(id);

    const state = {
        phase: 'idle',       // idle | memorize | transition | select | result
        difficulty: 25,      // 9 | 25 | 100
        colorMode: 'grayscale',
        original: null,
    };

    /* ============================================================
       Persistent Stats (localStorage)
    ============================================================ */

    let stats;
    try   { stats = JSON.parse(localStorage.getItem('colorMemoryGame')) || null; }
    catch { stats = null; }
    if (!stats || typeof stats.rounds !== 'number')
        stats = { rounds: 0, best: null, scores: [] };

    function saveStats() {
        try { localStorage.setItem('colorMemoryGame', JSON.stringify(stats)); } catch {}
    }

    function updateStatsUI() {
        $('stat-round').textContent = stats.rounds;
        $('stat-best').textContent  = stats.best !== null ? stats.best : '‚Äî';
        const avg = stats.scores.length
            ? Math.round(stats.scores.reduce((a,b) => a+b, 0) / stats.scores.length)
            : null;
        $('stat-avg').textContent = avg !== null ? avg : '‚Äî';
    }

    /* ============================================================
       Color Generation  (all in OKLab space)
    ============================================================ */

    function rand(lo, hi) { return lo + Math.random() * (hi - lo); }

    function generateOriginal() {
        if (state.colorMode === 'grayscale') {
            return { L: rand(0.25, 0.80), a: 0, b: 0 };
        }
        for (let i = 0; i < 500; i++) {
            const c = { L: rand(0.30, 0.80), a: rand(-0.15, 0.15), b: rand(-0.15, 0.15) };
            if (isInGamut(c)) return c;
        }
        return { L: 0.55, a: 0, b: 0 }; // safe fallback
    }

    function generateDistractors(original, count) {
        const pL  = 0.04;
        const pAB = state.colorMode === 'grayscale' ? 0 : 0.03;
        const minDE = 0.005;
        const result = [];

        for (let i = 0; i < count; i++) {
            let c, ok = false;
            for (let att = 0; att < 300; att++) {
                c = {
                    L: original.L + (Math.random() - 0.5) * 2 * pL,
                    a: original.a + (Math.random() - 0.5) * 2 * pAB,
                    b: original.b + (Math.random() - 0.5) * 2 * pAB,
                };
                if (isInGamut(c) && deltaE(original, c) >= minDE) { ok = true; break; }
            }
            if (!ok) {
                // Fallback: safe L-only shift
                const dir = (i % 2 === 0 ? 1 : -1) * 0.008 * (Math.floor(i / 2) + 1);
                c = { L: clamp(original.L + dir, 0.05, 0.95), a: original.a, b: original.b };
            }
            result.push(c);
        }
        return result;
    }

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    /* ============================================================
       Scoring & Feedback
    ============================================================ */

    function computeScore(de) {
        if (de === 0) return 100;
        const maxDE = state.colorMode === 'grayscale' ? 0.05 : 0.07;
        return Math.max(0, Math.round((1 - de / maxDE) * 100));
    }

    function getFeedback(score, perfect) {
        if (perfect) return 'üéØ ÂÆåÁæéÂëΩ‰∏≠ÔºÅ';
        if (score >= 90) return '‚ú® ÊÉä‰∫∫ÁöÑËâ≤ÂΩ©ËÆ∞ÂøÜ';
        if (score >= 70) return 'üëè Áõ∏ÂΩì‰∏çÈîô';
        if (score >= 50) return 'üí™ ËøòË°åÔºåÁªßÁª≠ÁªÉ‰π†';
        if (score >= 30) return 'ü§î ÈúÄË¶ÅÊõ¥Â§öÁªÉ‰π†';
        return 'üòÖ È¢úËâ≤ËÆ∞ÂøÜÁ°ÆÂÆûÂæàÈöæ';
    }

    /* ============================================================
       Rendering ‚Äî each phase replaces game-area innerHTML
    ============================================================ */

    const gameArea = $('game-area');

    // --- Phase 1: Memorize ---
    function renderMemorize() {
        state.phase = 'memorize';
        const c = state.original;

        gameArea.innerHTML = `
            <div class="phase-memorize">
                <div class="memorize-swatch" id="memo-block" style="${colorCss(c)}"></div>
                <p class="phase-hint">ËÆ∞‰ΩèËøô‰∏™È¢úËâ≤ ¬∑ ÂáÜÂ§áÂ•ΩÂêéÁÇπÂáªËâ≤Âùó</p>
            </div>`;

        $('memo-block').addEventListener('click', () => {
            if (state.phase === 'memorize') proceedToSelect();
        });
    }

    // --- Transition ---
    function proceedToSelect() {
        state.phase = 'transition';
        gameArea.innerHTML = '<div class="transition-msg">‰ªé‰∏ãÈù¢ÈÄâÂá∫‰Ω†ËÆ∞‰ΩèÁöÑÈ¢úËâ≤</div>';
        setTimeout(renderSelect, 700);
    }

    // --- Phase 2: Select ---
    function renderSelect() {
        state.phase = 'select';
        const original    = state.original;
        const distractors = generateDistractors(original, state.difficulty - 1);
        const all = shuffle([...distractors, { ...original, _orig: true }]);

        const gridCls = state.difficulty === 9 ? 'grid-3' : state.difficulty === 25 ? 'grid-5' : 'grid-10';
        const cells   = all.map((c, i) =>
            `<div class="grid-cell" data-idx="${i}" style="${colorCss(c)};animation-delay:${i * 6}ms"></div>`
        ).join('');

        gameArea.innerHTML = `<div class="color-grid ${gridCls}">${cells}</div>`;

        gameArea.querySelectorAll('.grid-cell').forEach(el => {
            el.addEventListener('click', () => {
                if (state.phase !== 'select') return;
                renderResult(all[+el.dataset.idx]);
            });
        });
    }

    // --- Phase 3: Result ---
    function renderResult(selected) {
        state.phase = 'result';
        const orig    = state.original;
        const de      = deltaE(orig, selected);
        const deDisp  = (de * 100).toFixed(1);   // scaled √ó100 for readability
        const perfect = !!selected._orig;
        const score   = computeScore(de);
        const fb      = getFeedback(score, perfect);
        const sClr    = score >= 70 ? 'var(--clr-success)' : score >= 40 ? 'var(--clr-warning)' : 'var(--clr-danger)';

        // update stats
        stats.rounds++;
        stats.scores.push(score);
        if (stats.scores.length > 100) stats.scores.shift();
        if (stats.best === null || score > stats.best) stats.best = score;
        saveStats();
        updateStatsUI();

        gameArea.innerHTML = `
            <div class="result-panel">
                <div class="result-swatches">
                    <div class="result-item">
                        <div class="result-label">ÂéüÂßãÈ¢úËâ≤</div>
                        <div class="result-swatch" style="${colorCss(orig)}"></div>
                        <div class="result-vals">L ${orig.L.toFixed(3)}  a ${orig.a.toFixed(3)}  b ${orig.b.toFixed(3)}</div>
                    </div>
                    <div class="result-vs">VS</div>
                    <div class="result-item">
                        <div class="result-label">‰Ω†ÁöÑÈÄâÊã©</div>
                        <div class="result-swatch" style="${colorCss(selected)}"></div>
                        <div class="result-vals">L ${selected.L.toFixed(3)}  a ${selected.a.toFixed(3)}  b ${selected.b.toFixed(3)}</div>
                    </div>
                </div>
                <div class="result-score" style="color:${sClr}">${score}</div>
                <div class="result-score-label">ÂæóÂàÜ</div>
                <div class="result-bar-wrap">
                    <div class="result-bar"><div class="result-bar-fill" id="score-bar-fill"></div></div>
                </div>
                <div class="result-delta">ŒîE<sub>OK</sub> = ${deDisp}</div>
                <div class="result-feedback">${fb}</div>
            </div>`;

        // Animate score bar after render
        requestAnimationFrame(() => {
            const fill = $('score-bar-fill');
            if (fill) fill.style.width = score + '%';
        });
    }

    /* ============================================================
       Game Control
    ============================================================ */

    function startGame() {
        state.original = generateOriginal();
        renderMemorize();
    }

    /* ============================================================
       Event Listeners
    ============================================================ */

    $('restart-btn').addEventListener('click', startGame);

    $('difficulty-group').addEventListener('click', e => {
        const btn = e.target.closest('.toggle-btn');
        if (!btn) return;
        $('difficulty-group').querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.difficulty = +btn.dataset.value;
        startGame();
    });

    $('mode-group').addEventListener('click', e => {
        const btn = e.target.closest('.toggle-btn');
        if (!btn) return;
        $('mode-group').querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.colorMode = btn.dataset.value;
        startGame();
    });

    /* ============================================================
       Init
    ============================================================ */
    updateStatsUI();
    startGame();
    </script>
</body>
</html>
